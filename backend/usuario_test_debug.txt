
> smartpyme-backend@1.0.0 test
> cross-env NODE_ENV=test jest --detectOpenHandles --forceExit usuarios.test.js

  console.log
    Ô£à Rutas de autenticaci├│n cargadas

      at Object.log (app.js:35:13)

  console.log
    Ô£à Rutas de usuarios cargadas

      at Object.log (app.js:42:13)

  console.log
    Ô£à Rutas de productos cargadas

      at Object.log (app.js:49:13)

  console.log
    Ô£à Rutas de categor├¡as cargadas

      at Object.log (app.js:56:13)

  console.log
    Ô£à Rutas de pedidos cargadas

      at Object.log (app.js:63:13)

  console.log
    Ô£à Rutas de configuraciones cargadas

      at Object.log (app.js:70:13)

  console.log
    Ô£à Rutas de tenants cargadas

      at Object.log (app.js:77:13)

  console.log
    Ô£à Rutas de estados cargadas

      at Object.log (app.js:84:13)

  console.log
    Ô£à Rutas de dashboard cargadas

      at Object.log (app.js:91:13)

  console.log
    Ô£à Rutas de recuperaci├│n de contrase├▒a cargadas

      at Object.log (app.js:98:13)

  console.log
    Ô£à Rutas de reportes cargadas

      at Object.log (app.js:105:13)

  console.log
    Ô£à Rutas de notificaciones cargadas

      at Object.log (app.js:112:13)

  console.log
    Ô£à Rutas de clientes cargadas

      at Object.log (app.js:119:13)

  console.log
    Ô£à Rutas de cat├ílogo p├║blico cargadas

      at Object.log (app.js:126:13)

  console.log
    Ô£à Rutas de perfil cargadas

      at Object.log (app.js:133:13)

  console.log
    ­ƒôØ Registro p├║blico - Body recibido: {
      nombre: 'Test',
      apellido: 'Client',
      email: 'client_usuarios_1764138179160@example.com',
      password: 'password123',
      tenant_id: 18
    }

      at log (controllers/auth.controller.js:244:17)

  console.log
    ­ƒöì Verificando email: client_usuarios_1764138179160@example.com

      at log (controllers/auth.controller.js:267:21)

  console.log
    Ô£à Creando usuario con rol cliente...

      at log (controllers/auth.controller.js:278:21)

  console.log
    ­ƒôì Asignando usuario al tenant: 18

      at log (controllers/auth.controller.js:289:21)

  console.log
    Ô£à Usuario creado exitosamente con ID: 171

      at log (controllers/auth.controller.js:293:21)

  console.log
    LOGIN P├ÜBLICO - BODY RECIBIDO: {
      email: 'client_usuarios_1764138179160@example.com',
      password: 'password123',
      tenant_id: 18
    }

      at log (controllers/auth.controller.js:7:17)

  console.log
    LOGIN ADMIN - BODY RECIBIDO: {
      email: 'admin@pasteleria-dulce-sabor.com',
      password: 'Admin123!',
      tenant_slug: 'pasteleria-dulce-sabor'
    }

      at log (controllers/auth.controller.js:116:17)

  console.log
    ­ƒöì DEBUG - Tenant obtenido de BD: {
      id: 18,
      nombre: 'Pasteler├¡a Dulce Sabor',
      slug: 'pasteleria-dulce-sabor',
      plan: 'basico',
      completo: {
        id_tenant: 18,
        nombre_empresa: 'Pasteler├¡a Dulce Sabor',
        slug: 'pasteleria-dulce-sabor',
        email_empresa: 'contacto@dulcesabor.com',
        telefono_empresa: null,
        direccion_empresa: null,
        descripcion: null,
        whatsapp: null,
        instagram: null,
        facebook: null,
        logo: null,
        plan: 'basico',
        activo: 1,
        fecha_inicio: 2025-11-24T03:00:00.000Z,
        fecha_fin: null,
        max_usuarios: 5,
        max_productos: 100,
        configuracion: null,
        created_at: 2025-11-24T15:48:01.000Z,
        updated_at: 2025-11-25T18:16:51.000Z
      }
    }

      at log (controllers/auth.controller.js:149:21)

node.exe : FAIL 
tests/usuarios.test.js
En C:\Program 
Files\nodejs\npm.ps1: 29 
Carácter: 3
+   & $NODE_EXE $NPM_CLI_JS 
$args
+   
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : 
No    tSpecified: (FAIL 
tests/usua    
rios.test.js:String) [], Rem   
 oteException
    + FullyQualifiedErrorId : 
Na    tiveCommandError
 
  Usuario Endpoints
    ├ù should create a user as 
admin (40 ms)
    ÔêÜ should fail to create 
user as client (15 ms)
    ÔêÜ should list users as 
admin (23 ms)
    ÔêÜ should fail to list 
users as client (14 ms)
    ├ù should update user as 
admin (17 ms)
    ÔêÜ should fail to update 
user as client (15 ms)
    ├ù should get user 
statistics as admin (15 ms)
    ├ù should delete user as 
admin (13 ms)
    ├ù should fail to delete 
user as client (15 ms)
    ÔêÜ should validate 
required fields when creating 
user (18 ms)
    ÔêÜ should prevent 
duplicate email (19 ms)

  ÔùÅ Usuario Endpoints ÔÇ║ 
should create a user as admin

    expect(received).toEqual(ex
pected) // deep equality

    Expected: 201
    Received: 400

    [0m [90m 76 |[39m       
      [33m.[39msend(testUser)
[33m;[39m
     [90m 77 |[39m
    [31m[1m>[22m[39m[90m 
78 |[39m         expect(res[3
3m.[39mstatusCode)[33m.[39mt
oEqual([35m201[39m)[33m;[39
m
     [90m    |[39m           
                     
[31m[1m^[22m[39m
     [90m 79 |[39m         ex
pect(res[33m.[39mbody[33m.[
39msuccess)[33m.[39mtoBe([36
mtrue[39m)[33m;[39m
     [90m 80 |[39m         ex
pect(res[33m.[39mbody[33m.[
39mdata)[33m.[39mtoHaveProper
ty([32m'id_usuario'[39m)[33m
;[39m
     [90m 81 |[39m         
testUserId [33m=[39m res[33m
.[39mbody[33m.[39mdata[33m.
[39mid_usuario[33m;[39m[0m

      at Object.toEqual 
(tests/usuarios.test.js:78:32)

  ÔùÅ Usuario Endpoints ÔÇ║ 
should update user as admin

    expect(received).toEqual(ex
pected) // deep equality

    Expected: 200
    Received: 400

    [0m [90m 120 |[39m      
       [33m.[39msend(updatedD
ata)[33m;[39m
     [90m 121 |[39m
    [31m[1m>[22m[39m[90m 
122 |[39m         expect(res[
33m.[39mstatusCode)[33m.[39m
toEqual([35m200[39m)[33m;[3
9m
     [90m     |[39m          
                      
[31m[1m^[22m[39m
     [90m 123 |[39m         e
xpect(res[33m.[39mbody[33m.
[39msuccess)[33m.[39mtoBe([3
6mtrue[39m)[33m;[39m
     [90m 124 |[39m     
})[33m;[39m
     [90m 125 |[39m[0m

      at Object.toEqual 
(tests/usuarios.test.js:122:32)

  ÔùÅ Usuario Endpoints ÔÇ║ 
should get user statistics as 
admin

    expect(received).toEqual(ex
pected) // deep equality

    Expected: 200
    Received: 400

    [0m [90m 138 |[39m      
       [33m.[39m[36mset[39m
([32m'Authorization'[39m[33m
,[39m [32m`Bearer 
${adminToken}`[39m)[33m;[39m
     [90m 139 |[39m
    [31m[1m>[22m[39m[90m 
140 |[39m         expect(res[
33m.[39mstatusCode)[33m.[39m
toEqual([35m200[39m)[33m;[3
9m
     [90m     |[39m          
                      
[31m[1m^[22m[39m
     [90m 141 |[39m         e
xpect(res[33m.[39mbody[33m.
[39mdata)[33m.[39mtoHavePrope
rty([32m'total'[39m)[33m;[3
9m
     [90m 142 |[39m         e
xpect(res[33m.[39mbody[33m.
[39mdata)[33m.[39mtoHavePrope
rty([32m'porRol'[39m)[33m;[
39m
     [90m 143 |[39m     
})[33m;[39m[0m

      at Object.toEqual 
(tests/usuarios.test.js:140:32)

  ÔùÅ Usuario Endpoints ÔÇ║ 
should delete user as admin

    expect(received).toEqual(ex
pected) // deep equality

    Expected: 200
    Received: 400

    [0m [90m 148 |[39m      
       [33m.[39m[36mset[39m
([32m'Authorization'[39m[33m
,[39m [32m`Bearer 
${adminToken}`[39m)[33m;[39m
     [90m 149 |[39m
    [31m[1m>[22m[39m[90m 
150 |[39m         expect(res[
33m.[39mstatusCode)[33m.[39m
toEqual([35m200[39m)[33m;[3
9m
     [90m     |[39m          
                      
[31m[1m^[22m[39m
     [90m 151 |[39m         e
xpect(res[33m.[39mbody[33m.
[39msuccess)[33m.[39mtoBe([3
6mtrue[39m)[33m;[39m
     [90m 152 |[39m
     [90m 153 |[39m         
[90m// Mark as deleted so 
cleanup doesn't try to delete 
again[39m[0m

      at Object.toEqual 
(tests/usuarios.test.js:150:32)

  ÔùÅ Usuario Endpoints ÔÇ║ 
should fail to delete user as 
client

    TypeError: Cannot read 
properties of undefined 
(reading 'id_usuario')

    [0m [90m 168 |[39m      
       })[33m;[39m
     [90m 169 |[39m
    [31m[1m>[22m[39m[90m 
170 |[39m         
[36mconst[39m userId 
[33m=[39m createRes[33m.[39
mbody[33m.[39mdata[33m.[39m
id_usuario[33m;[39m
     [90m     |[39m          
                               
   [31m[1m^[22m[39m
     [90m 171 |[39m
     [90m 172 |[39m         
[36mconst[39m res 
[33m=[39m [36mawait[39m 
request(app)
     [90m 173 |[39m          
   [33m.[39m[36mdelete[39m(
[32m`/api/usuarios/${userId}`
[39m)[0m

      at Object.id_usuario 
(tests/usuarios.test.js:170:44)

---------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------
File                             | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                    
---------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------
All files                        |   21.34 |     6.63 |    8.57 |   21.41 |                                                                                                      
 backend                         |   71.76 |       10 |       0 |   71.76 |                                                                                                      
  app.js                         |   71.76 |       10 |       0 |   71.76 | 25,37,44,51,58,65,72,79,86,93,100,107,114,121,128,135,140,154-171,180                                
 backend/controllers             |    9.63 |     5.91 |    4.44 |    9.65 |                                                                                                      
  auth.controller.js             |    47.7 |    48.48 |      50 |    47.7 | 13,21,30,38,46,54,63,106-107,122,130,139,158,165,173,181,190,234-235,250-251,259-260,270-271,301-424 
  categoria.controller.js        |    5.19 |        0 |       0 |    5.19 | 7-200                                                                                                
  cliente.controller.js          |    4.76 |        0 |       0 |    4.76 | 7-217                                                                                                
  dashboard.controller.js        |   10.52 |        0 |       0 |   10.52 | 6-52                                                                                                 
  notificaciones.controller.js   |    6.38 |        0 |       0 |    6.38 | 6-136                                                                                                
  passwordRecovery.controller.js |    8.16 |        0 |       0 |    8.16 | 8-141                                                                                                
  pedido.controller.js           |    2.63 |        0 |       0 |    2.63 | 7-468                                                                                                
  producto.controller.js         |    4.16 |        0 |       0 |    4.16 | 7-256                                                                                                
  reportes.controller.js         |    4.31 |        0 |       0 |    4.31 | 11-342                                                                                               
  settings.controller.js         |    7.14 |        0 |       0 |    7.14 | 5-77                                                                                                 
  tenant.controller.js           |     5.1 |        0 |       0 |     5.1 | 11-557                                                                                               
  usuario.controller.js          |    6.14 |     1.26 |      10 |    6.25 | 15-326                                                                                               
 backend/middlewares             |   60.24 |    39.62 |   77.77 |   60.24 |                                                                                                      
  auth.js                        |   65.21 |       40 |   66.66 |   65.21 | 9,25,38,44-52                                                                                        
  permissions.js                 |    90.9 |    55.55 |     100 |    90.9 | 33                                                                                                   
  tenant.js                      |   51.02 |    35.29 |      75 |   51.02 | 20,29,37,45-48,69-70,82-100,112,121,133,145,158-159                                                  
 backend/models                  |    7.88 |      1.5 |    7.69 |    7.92 |                                                                                                      
  categoria.model.js             |    4.65 |        0 |       0 |    4.65 | 5-127                                                                                                
  cliente.model.js               |    4.47 |        0 |       0 |    4.47 | 7-143                                                                                                
  dashboard.model.js             |    7.69 |        0 |       0 |    7.69 | 6-150                                                                                                
  notificaciones.model.js        |    4.34 |        0 |       0 |    4.34 | 6-185                                                                                                
  passwordRecovery.model.js      |   27.27 |        0 |       0 |   27.27 | 7-41                                                                                                 
  pedido.model.js                |    2.11 |        0 |       0 |    2.12 | 16-609                                                                                               
  producto.model.js              |    6.06 |        0 |       0 |    6.06 | 5-137                                                                                                
  reportes.model.js              |    4.76 |        0 |       0 |    4.76 | 9-255                                                                                                
  settings.model.js              |    8.69 |      100 |       0 |    8.69 | 5-67                                                                                                 
  tenant.model.js                |   15.06 |     2.77 |      25 |   15.27 | 8-19,33,47-64,94-314                                                                                 
  usuario.model.js               |   18.75 |     12.9 |   30.76 |   18.98 | 20-52,67,91-214,225-247                                                                              
 backend/routes                  |   61.56 |        0 |       0 |   61.98 |                                                                                                      
  auth.routes.js                 |     100 |      100 |     100 |     100 |                                                                                                      
  catalogo.routes.js             |   17.02 |        0 |       0 |   17.77 | 8-30,39-70,79-108                                                                                    
  categorias.routes.js           |     100 |      100 |     100 |     100 |                                                                                                      
  clientes.routes.js             |     100 |      100 |     100 |     100 |                                                                                                      
  dashboard.routes.js            |     100 |      100 |     100 |     100 |                                                                                                      
  estados.routes.js              |   54.54 |      100 |       0 |   54.54 | 8-21                                                                                                 
  notificaciones.routes.js       |     100 |      100 |     100 |     100 |                                                                                                      
  passwordRecovery.routes.js     |     100 |      100 |     100 |     100 |                                                                                                      
  pedidos.routes.js              |     100 |      100 |     100 |     100 |                                                                                                      
  perfil.routes.js               |   12.65 |        0 |       0 |   12.65 | 12-32,41-85,94-243                                                                                   
  productos.routes.js            |     100 |      100 |     100 |     100 |                                                                                                      
  reportes.routes.js             |     100 |      100 |     100 |     100 |                                                                                                      
  settings.routes.js             |     100 |      100 |     100 |     100 |                                                                                                      
  tenants.routes.js              |     100 |      100 |     100 |     100 |                                                                                                      
  usuarios.routes.js             |     100 |      100 |     100 |     100 |                                                                                                      
 backend/services                |   11.32 |    20.83 |       0 |   11.32 |                                                                                                      
  email.service.js               |   11.32 |    20.83 |       0 |   11.32 | 20-23,29-318                                                                                         
 backend/validators              |     100 |      100 |     100 |     100 |                                                                                                      
  categoria.validator.js         |     100 |      100 |     100 |     100 |                                                                                                      
  producto.validator.js          |     100 |      100 |     100 |     100 |                                                                                                      
  usuario.validator.js           |     100 |      100 |     100 |     100 |                                                                                                      
---------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 1 total
Tests:       5 failed, 6 
passed, 11 total
Snapshots:   0 total
Time:        2.857 s, 
estimated 3 s
Ran all test suites matching 
usuarios.test.js.
