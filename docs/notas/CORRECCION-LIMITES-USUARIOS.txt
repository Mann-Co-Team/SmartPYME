â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ”§ CORRECCIÃ“N: DIFERENCIACIÃ“N DE USUARIOS STAFF VS CLIENTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“… Fecha: 25 de Noviembre de 2025
ðŸŽ¯ Objetivo: Diferenciar correctamente usuarios admin/empleados de clientes en lÃ­mites

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ PROBLEMA IDENTIFICADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El sistema contaba TODOS los usuarios (admin, empleados Y clientes) para el lÃ­mite
del plan, cuando deberÃ­a contar solo admin y empleados.

Ejemplo en Plan BÃ¡sico:
  âŒ ANTES: "4 usuarios de 1" (contaba 1 admin + 1 empleado + 2 clientes = 4)
  âœ… AHORA: "2 staff de 5" (cuenta solo 1 admin + 1 empleado = 2)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… SOLUCIÃ“N IMPLEMENTADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. BACKEND - Query checkLimits() Corregido
   Archivo: backend/models/tenant.model.js
   
   ANTES:
   ```sql
   COUNT(DISTINCT u.id_usuario) as usuarios_actuales
   ```
   
   DESPUÃ‰S:
   ```sql
   COUNT(DISTINCT CASE WHEN u.id_rol IN (1, 2) THEN u.id_usuario END) as usuarios_actuales,
   COUNT(DISTINCT CASE WHEN u.id_rol = 3 THEN u.id_usuario END) as clientes_actuales
   ```
   
   Resultado: Ahora devuelve contadores separados

2. BACKEND - Middleware checkTenantLimit Mejorado
   Archivo: backend/middlewares/tenant.js
   
   ANTES: Validaba lÃ­mite para cualquier usuario
   
   DESPUÃ‰S:
   ```javascript
   // Solo validar lÃ­mite si se estÃ¡ creando admin/empleado (roles 1 o 2)
   const id_rol = req.body.id_rol;
   if (id_rol && (id_rol === 1 || id_rol === 2) && limits.limite_usuarios_alcanzado) {
       return res.status(403).json({
           message: 'LÃ­mite de administradores/empleados alcanzado...'
       });
   }
   ```
   
   Resultado: Clientes (rol 3) no afectan el lÃ­mite

3. BACKEND - Middleware Agregado a Ruta
   Archivo: backend/routes/usuarios.routes.js
   
   ANTES:
   ```javascript
   router.post('/', authorize('manage_users'), createUsuario, UsuarioController.create);
   ```
   
   DESPUÃ‰S:
   ```javascript
   router.post('/', authorize('manage_users'), checkTenantLimit('usuarios'), createUsuario, UsuarioController.create);
   ```
   
   Resultado: Valida lÃ­mite antes de crear usuario

4. FRONTEND - LÃ­mites de Planes Corregidos
   Archivo: frontend/src/pages/admin/Settings.jsx
   
   ANTES:
   ```javascript
   basico: { usuarios: 1, productos: 50 }
   profesional: { usuarios: 5, productos: 500 }
   ```
   
   DESPUÃ‰S:
   ```javascript
   basico: { usuarios: 5, productos: 100 }
   profesional: { usuarios: 20, productos: 500 }
   ```

5. FRONTEND - UI Clarificada
   Archivo: frontend/src/pages/admin/Settings.jsx
   
   CAMBIOS:
   - Etiqueta: "ðŸ‘¥ Usuarios" â†’ "ðŸ‘¥ Staff"
   - Agregado: tooltip "LÃ­mite de administradores y empleados"
   - Agregado: subtexto "Admin/Empleados"

6. FRONTEND - GestiÃ³n de Usuarios Actualizada
   Archivo: frontend/src/pages/admin/Usuarios.jsx
   
   ANTES:
   ```javascript
   const canAddMoreUsers = () => {
       return usuarios.length < limit;
   }
   ```
   
   DESPUÃ‰S:
   ```javascript
   const canAddMoreUsers = () => {
       const staffCount = usuarios.filter(u => u.id_rol === 1 || u.id_rol === 2).length;
       return staffCount < limit;
   }
   ```
   
   UI MEJORADA:
   ```
   ðŸ‘¥ Staff: 2 / 5
   ðŸ‘¤ Clientes: 2 (ilimitados)
   ```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š LÃMITES POR PLAN (CORREGIDOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PLAN BÃSICO:
  ðŸ‘¥ Staff (Admin/Empleados): 5
  ðŸ‘¤ Clientes: âˆž ilimitados
  ðŸ“¦ Productos: 100
  ðŸ“‹ Pedidos: 100/mes

PLAN PROFESIONAL:
  ðŸ‘¥ Staff (Admin/Empleados): 20
  ðŸ‘¤ Clientes: âˆž ilimitados
  ðŸ“¦ Productos: 500
  ðŸ“‹ Pedidos: âˆž ilimitados

PLAN EMPRESARIAL:
  ðŸ‘¥ Staff (Admin/Empleados): âˆž ilimitados
  ðŸ‘¤ Clientes: âˆž ilimitados
  ðŸ“¦ Productos: âˆž ilimitados
  ðŸ“‹ Pedidos: âˆž ilimitados

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ§ª VERIFICACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TENANT: pasteleria-dulce-sabor (ID: 18)
PLAN: bÃ¡sico

USUARIOS:
  ðŸ‘‘ Admin: 1
  ðŸ‘¨â€ðŸ’¼ Empleados: 1
  ðŸ‘¤ Clientes: 2
  
CONTEO PARA LÃMITE:
  âœ… Staff: 2 de 5 (40% usado)
  âœ… Clientes: 2 (no cuentan para lÃ­mite)

RESPUESTA API checkLimits():
  ```json
  {
    "usuarios_actuales": 2,        â† Solo admin/empleados
    "max_usuarios": 5,
    "limite_usuarios_alcanzado": 0,
    "clientes_actuales": 2         â† Contador separado
  }
  ```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ ARCHIVOS MODIFICADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… backend/models/tenant.model.js
   - Query checkLimits() con CASE para contar solo roles 1 y 2
   - Agregado contador clientes_actuales

âœ… backend/middlewares/tenant.js
   - ValidaciÃ³n solo para roles 1 y 2 (admin/empleado)
   - Mensaje mejorado: "LÃ­mite de administradores/empleados alcanzado"

âœ… backend/routes/usuarios.routes.js
   - Importado checkTenantLimit
   - Agregado middleware a POST /usuarios

âœ… frontend/src/pages/admin/Settings.jsx
   - LÃ­mites corregidos: bÃ¡sico 5, profesional 20
   - UI: "Usuarios" â†’ "Staff" con tooltip
   - Subtexto "Admin/Empleados"

âœ… frontend/src/pages/admin/Usuarios.jsx
   - getPlanLimits() corregido
   - canAddMoreUsers() cuenta solo staff
   - UI muestra contadores separados: Staff y Clientes

âœ… backend/analizar-usuarios.js (CREADO)
   - Script para verificar conteo de usuarios por rol

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’¡ CONSIDERACIONES IMPORTANTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ROLES:
   - Rol 1 (Admin): Cuenta para lÃ­mite âœ…
   - Rol 2 (Empleado): Cuenta para lÃ­mite âœ…
   - Rol 3 (Cliente): NO cuenta para lÃ­mite âœ…

2. CLIENTES:
   - Son ILIMITADOS en todos los planes
   - No afectan el lÃ­mite de usuarios del plan
   - Se registran desde la tienda pÃºblica

3. STAFF:
   - Admin y empleados SÃ cuentan para el lÃ­mite
   - Se crean desde panel administrativo
   - Plan bÃ¡sico: mÃ¡ximo 5 staff

4. VALIDACIÃ“N:
   - Backend valida al crear usuario
   - Frontend previene botÃ³n "Nuevo Usuario" cuando lÃ­mite alcanzado
   - Middleware checkTenantLimit solo para roles 1 y 2

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… SISTEMA CORREGIDO Y FUNCIONANDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ahora el sistema diferencia correctamente entre:
  ðŸ‘¥ Staff (admin/empleados) â†’ Limitado segÃºn plan
  ðŸ‘¤ Clientes â†’ Ilimitados siempre

El panel administrativo muestra claramente:
  "ðŸ‘¥ Staff: 2 / 5"
  "ðŸ‘¤ Clientes: 2 (ilimitados)"
